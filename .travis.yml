language: ruby

rvm:
#  - jruby-19mode
  - jruby-9.1.6.0
#  - jruby-head

matrix:
  include:
#    - os: linux
#      rvm: jruby-19mode
#      jdk: openjdk7
#      env: INTEG_SUITE="spec:all" WILDFLY_VERSION="9.0.1.Final"
    - os: linux
      rvm: jruby-9.1.6.0
      jdk: openjdk7
      env: WILDFLY_VERSION="9.0.1.Final"
    - os: osx
      rvm: jruby-9.1.6.0
      jdk:
    - os: osx
      rvm: jruby-9.1.6.0
      jdk:
      env:
        - WILDFLY_VERSION="9.0.1.Final"
        - SSL_CERT_FILE=/Library/Java/Home/lib/security/cacerts
        - JAVA_OPTS="-Xmx1536m -XX:MaxPermSize=512M"
      osx_image: beta-xcode6.1
#  allow_failures:
#    - rvm: jruby-head

#jdk:
#  - oraclejdk8

env:
  global:
    - INTEG_SUITE=spec:all
    - JAVA_OPTS="-Xmx1536m"
    - JRUBY_OPTS="--client -J-XX:+TieredCompilation -J-XX:TieredStopAtLevel=1 -J-Xss2m -Xcompile.invokedynamic=false"

sudo: false

cache:
  directories:
    - $HOME/.m2/repository

before_install:
  - gem install bundler
  - gem update bundler
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then curl -O https://storage.googleapis.com/google-code-archive-downloads/v2/code.google.com/phantomjs/phantomjs-1.8.1-macosx.zip ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then unzip phantomjs-1.8.1-macosx.zip ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then export PATH="$PWD/phantomjs-1.8.1-macosx/bin:$PATH" ; fi

install: travis_retry bundle install

before_script:
  - unset RACK_ENV RAILS_ENV
  - bundle exec rake build

script:
  - bundle exec rake rubocop
  - bundle exec rake spec
  - cd integration-tests
  - travis_wait bundle exec rake spec:wildfly:setup
  - bundle exec rake $INTEG_SUITE

branches:
  only:
    - master
