language: ruby

rvm:
  - jruby-19mode
  - jruby-9.1.6.0
  - jruby-head

matrix:
  include:
    - os: linux
      rvm: jruby-19mode
      jdk: openjdk7
      env: INTEG_SUITE="spec:all" WILDFLY_VERSION="9.0.1.Final"
    - os: linux
      rvm: jruby-9.1.6.0
      jdk: openjdk7
      env: INTEG_SUITE="spec:all" WILDFLY_VERSION="9.0.1.Final"
    - os: linux
      rvm: jruby-19mode
      jdk: oraclejdk8
      env: INTEG_SUITE="spec:all" WILDFLY_VERSION="9.0.1.Final"
    - os: linux
      rvm: jruby-9.1.6.0
      jdk: oraclejdk8
      env: INTEG_SUITE="spec:all" WILDFLY_VERSION="9.0.1.Final"
    - os: osx
  allow_failures:
    - rvm: jruby-head

env:
  matrix:
    - INTEG_SUITE=spec:all
  global:
    - JAVA_OPTS="-Xmx1536m"

sudo: false

cache:
  directories:
    - $HOME/.m2/repository

before_install:
  - gem install bundler
  - gem update bundler
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then curl -O https://storage.googleapis.com/google-code-archive-downloads/v2/code.google.com/phantomjs/phantomjs-1.8.1-macosx.zip ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then unzip phantomjs-1.8.1-macosx.zip ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then export PATH=$PWD/phantomjs-1.8.1/bin:$PATH ; fi

install: travis_retry bundle install

before_script:
  - unset RACK_ENV RAILS_ENV
  - bundle exec rake build

script:
  - bundle exec rake rubocop
  - bundle exec rake spec
  - cd integration-tests
  - travis_wait bundle exec rake spec:wildfly:setup
  - bundle exec rake $INTEG_SUITE

branches:
  only:
    - master
